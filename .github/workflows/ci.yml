name: CI

on:
  push:
    branches: [ master, main, develop ]
  pull_request:
    branches: [ master, main, develop ]

jobs:
  test:
    runs-on: ubuntu-latest

    services:
      mysql:
        image: mysql:8.0
        env:
          MYSQL_ROOT_PASSWORD: test
          MYSQL_DATABASE: novels_test
          MYSQL_USER: novel
          MYSQL_PASSWORD: test
        ports:
          - 3306:3306
        options: >-
          --health-cmd="mysqladmin ping"
          --health-interval=10s
          --health-timeout=5s
          --health-retries=5

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'maven'

    - name: Run tests
      run: ./mvnw test
      env:
        SPRING_DATASOURCE_URL: jdbc:mysql://localhost:3306/novels_test
        SPRING_DATASOURCE_USERNAME: novel
        SPRING_DATASOURCE_PASSWORD: test

  build:
    needs: test
    runs-on: ubuntu-latest
    if: success()

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK 17
      uses: actions/setup-java@v4
      with:
        java-version: '17'
        distribution: 'temurin'
        cache: 'maven'

    - name: Build frontend
      run: |
        cd web-ui
        npm install
        npm run build

    - name: Build JAR
      run: ./mvnw package -DskipTests

    - name: Upload JAR artifact
      uses: actions/upload-artifact@v4
      with:
        name: novelspider-jar
        path: target/NovelSpider-*.jar
        retention-days: 7

  build-native:
    needs: test
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/master' || github.ref == 'refs/heads/main')
    timeout-minutes: 60

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up GraalVM
      uses: graalvm/setup-graalvm@v1
      with:
        java-version: '21'
        distribution: 'graalvm-community'
        github-token: ${{ secrets.GITHUB_TOKEN }}

    - name: Install native-image
      run: gu install native-image

    - name: Cache Maven packages
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Build frontend
      run: |
        cd web-ui
        npm install
        npm run build

    - name: Build native image
      run: ./mvnw -Pnative clean package -DskipTests
      env:
        JAVA_HOME: ${{ env.GRAALVM_HOME }}

    - name: Compress native binary
      run: |
        cd target
        tar czf novelspider-linux-amd64.tar.gz NovelSpider
        sha256sum NovelSpider > novelspider-linux-amd64.sha256

    - name: Upload native binary artifact
      uses: actions/upload-artifact@v4
      with:
        name: novelspider-native-linux-amd64
        path: |
          target/NovelSpider
          target/novelspider-linux-amd64.tar.gz
          target/novelspider-linux-amd64.sha256
        retention-days: 30
